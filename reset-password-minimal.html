---
layout: auth
title: Reset Password
permalink: /reset-password/index.html
disable_auth_check: true
---

<div class="login-container">
  <h2 id="rp-title">Reset Password</h2>
  <div id="rp-error" class="error-message"></div>
  <div id="rp-success" class="success-message"></div>

  <div id="rp-stage-check">
    <p class="text-center text-muted">Checking recovery link...</p>
  </div>

  <form id="rp-form" style="display:none;">
    <div class="form-group">
      <label for="rp-email">Email</label>
      <input type="email" id="rp-email" name="rp-email" readonly>
    </div>
    <div class="form-group">
      <label for="rp-new-password">New Password</label>
      <input type="password" id="rp-new-password" name="rp-new-password" minlength="6" required>
    </div>
    <div class="form-group">
      <label for="rp-confirm-password">Confirm Password</label>
      <input type="password" id="rp-confirm-password" name="rp-confirm-password" minlength="6" required>
    </div>
    <div class="form-actions">
      <button type="submit" class="btn" id="rp-submit">Update Password</button>
      <a class="btn btn-secondary" href="{{ '/login/' | relative_url }}">Back to Login</a>
    </div>
  </form>
</div>

<script>
(function(){
  // CRITICAL: Capture hash IMMEDIATELY before Supabase processes it
  const initialHash = window.location.hash.substring(1);
  const initialHashParams = new URLSearchParams(initialHash);
  const recoveryType = initialHashParams.get('type');
  
  console.log('[reset-password] Initial hash captured:', initialHash ? 'YES' : 'NO');
  console.log('[reset-password] Recovery type:', recoveryType);
  
  const errorEl = document.getElementById('rp-error');
  const successEl = document.getElementById('rp-success');
  const formEl = document.getElementById('rp-form');
  const stageCheck = document.getElementById('rp-stage-check');
  const emailInput = document.getElementById('rp-email');
  const newPassInput = document.getElementById('rp-new-password');
  const confirmInput = document.getElementById('rp-confirm-password');
  const submitBtn = document.getElementById('rp-submit');

  function show(el){ el.style.display='block'; }
  function hide(el){ el.style.display='none'; }
  function setError(msg){ errorEl.textContent=msg; show(errorEl); }
  function setSuccess(msg){ successEl.textContent=msg; show(successEl); }
  function clearMessages(){ hide(errorEl); hide(successEl); errorEl.textContent=''; successEl.textContent=''; }

  // Indicate checking state
  show(stageCheck);

  async function init(){
    try {
      console.log('[reset-password] Init starting...');
      console.log('[reset-password] Captured hash params:', {
        type: recoveryType,
        access_token: initialHashParams.get('access_token') ? 'present' : 'missing',
        refresh_token: initialHashParams.get('refresh_token') ? 'present' : 'missing'
      });
      
      // Check if this is a recovery flow using the captured hash
      if (recoveryType !== 'recovery') {
        console.log('[reset-password] ERROR: Not a recovery type, got:', recoveryType);
        hide(stageCheck);
        setError('Invalid or expired recovery link. Please click the link in your password reset email again, or request a new password reset from the login page.');
        return;
      }
      
      console.log('[reset-password] Recovery type confirmed, waiting for Supabase to process...');
      
      // Wait a moment for Supabase to process the hash and establish session
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      console.log('[reset-password] Getting session after wait...');
      
      // Get current session (should be established automatically by recovery link)
      const { data: { session }, error } = await supabase.auth.getSession();
      
      console.log('[reset-password] Session check result:', {
        hasSession: !!session,
        hasUser: !!(session && session.user),
        error: error ? error.message : 'none'
      });
      
      if (error) {
        hide(stageCheck);
        setError('Failed to validate session: ' + error.message);
        return;
      }
      if (!session || !session.user) {
        hide(stageCheck);
        setError('Recovery session not found or expired. Try sending a new reset email.');
        return;
      }
      console.log('[reset-password] Session valid, showing form for user:', session.user.email);
      emailInput.value = session.user.email || '';
      hide(stageCheck);
      show(formEl);
    } catch(e){
      console.error('[reset-password] Exception in init:', e);
      hide(stageCheck);
      setError('Unexpected error: ' + (e.message || e));
    }
  }

  formEl.addEventListener('submit', async (e)=>{
    e.preventDefault();
    clearMessages();
    const pass = newPassInput.value.trim();
    const confirm = confirmInput.value.trim();
    if (!pass || pass.length < 6) {
      setError('Password must be at least 6 characters.');
      return;
    }
    if (pass !== confirm) {
      setError('Passwords do not match.');
      return;
    }

    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Updating...';
    submitBtn.disabled = true;

    const result = await updatePassword(pass);

    submitBtn.textContent = originalText;
    submitBtn.disabled = false;

    if(result.success){
      setSuccess('Password updated! Redirecting to login...');
      await handleLogout();
      setTimeout(()=>{ window.location.href = siteUrl('/login/'); }, 1500);
    } else {
      setError(result.error || 'Failed to update password.');
    }
  });

  // Start initialization
  init();
})();
</script>
