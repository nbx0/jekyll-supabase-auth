---
layout: default
title: Reset Password
permalink: /reset-password/index.html
---

<div class="login-container">
  <h2 id="rp-title">Reset Password</h2>
  <div id="rp-error" class="error-message" style="display:none;"></div>
  <div id="rp-success" class="success-message" style="display:none;"></div>

  <div id="rp-stage-check" style="display:none;">
    <p>Checking recovery link...</p>
  </div>

  <form id="rp-form" style="display:none;">
    <div class="form-group">
      <label for="rp-email">Email</label>
      <input type="email" id="rp-email" name="rp-email" readonly>
    </div>
    <div class="form-group">
      <label for="rp-new-password">New Password</label>
      <input type="password" id="rp-new-password" name="rp-new-password" minlength="6" required>
    </div>
    <div class="form-group">
      <label for="rp-confirm-password">Confirm Password</label>
      <input type="password" id="rp-confirm-password" name="rp-confirm-password" minlength="6" required>
    </div>
    <div class="form-actions" style="display:flex; gap:.5rem; align-items:center;">
      <button type="submit" class="btn" id="rp-submit">Update Password</button>
      <a class="btn btn-secondary" href="{{ '/login/' | relative_url }}">Back to Login</a>
    </div>
  </form>
</div>

<script>
(function(){
  const errorEl = document.getElementById('rp-error');
  const successEl = document.getElementById('rp-success');
  const formEl = document.getElementById('rp-form');
  const stageCheck = document.getElementById('rp-stage-check');
  const emailInput = document.getElementById('rp-email');
  const newPassInput = document.getElementById('rp-new-password');
  const confirmInput = document.getElementById('rp-confirm-password');
  const submitBtn = document.getElementById('rp-submit');

  function show(el){ el.style.display='block'; }
  function hide(el){ el.style.display='none'; }
  function setError(msg){ errorEl.textContent=msg; show(errorEl); }
  function setSuccess(msg){ successEl.textContent=msg; show(successEl); }
  function clearMessages(){ hide(errorEl); hide(successEl); errorEl.textContent=''; successEl.textContent=''; }

  // Indicate checking state
  show(stageCheck);

  async function init(){
    try {
      // Supabase attaches the session info via hash (#access_token=...&type=recovery)
      const hashParams = new URLSearchParams(window.location.hash.replace('#','?'));
      const type = hashParams.get('type');
      if (type !== 'recovery') {
        hide(stageCheck);
        setError('Invalid or expired recovery link. Request a new password reset.');
        return;
      }
      // Get current session (should be established automatically by recovery link)
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) {
        hide(stageCheck);
        setError('Failed to validate session: ' + error.message);
        return;
      }
      if (!session || !session.user) {
        hide(stageCheck);
        setError('Recovery session not found or expired. Try sending a new reset email.');
        return;
      }
      emailInput.value = session.user.email || '';
      hide(stageCheck);
      show(formEl);
    } catch(e){
      hide(stageCheck);
      setError('Unexpected error: ' + (e.message || e));
    }
  }

  formEl.addEventListener('submit', async (e)=>{
    e.preventDefault();
    clearMessages();
    const pass = newPassInput.value.trim();
    const confirm = confirmInput.value.trim();
    if (!pass || pass.length < 6) {
      setError('Password must be at least 6 characters.');
      return;
    }
    if (pass !== confirm) {
      setError('Passwords do not match.');
      return;
    }
    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';
    try {
      const { error } = await supabase.auth.updateUser({ password: pass });
      if (error) {
        setError('Update failed: ' + error.message);
      } else {
        setSuccess('Password updated successfully. You can now log in.');
        newPassInput.value='';
        confirmInput.value='';
      }
    } catch(e){
      setError('Unexpected error: ' + (e.message || e));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Password';
    }
  });

  // Kick off
  if (window.supabase) {
    init();
  } else {
    window.addEventListener('load', init);
  }
})();
</script>
